@using BussinessObject;
@using DataAccess;

<html>

<head>
    <!-- Load Base -->
    @RenderPage("Base.cshtml")
</head>

<body>
    <!-- Content -->
    <div class="container">
        <h4>Update Schedule</h4>
        @{
            Validation.RequireField("MatchTime", "A match time is required.");
            Validation.RequireField("Team1", "Team1 is required.");
            Validation.RequireField("Team2", "Team2 is required.");

            DateTime MatchTime = DateTime.MinValue;
            string Team1 = "";
            string Team2 = "";
            int Team1ID = 0;
            int Team2ID = 0;

            string MatchId = UrlData[0];
            if (MatchId.IsEmpty())
            {
                Response.Redirect("~/schedule.cshtml");
            }

            GetUserType type = new GetUserType();
            if (Session["UserType"] != null)
            {
                if (!type.isUserSuper((string)Session["UserType"]))
                {
                    Response.Redirect("~/index.cshtml");
                }
            }
            else
            {
                Response.Redirect("~/index.cshtml");
            }

            ScheduleData accessData = new ScheduleData();

            if (IsPost && Validation.IsValid())
            {

                if (Request.Form["update"] == "update")
                {
                    MatchTime = Request["MatchTime"].AsDateTime();
                    int team1ID = int.Parse(Request["Team1"]);
                    int team2ID = int.Parse(Request["Team2"]);
                    Team1 = Request["Team1"];
                    Team2 = Request["Team2"];
                    accessData.UpdateMatch(int.Parse(MatchId), MatchTime, team1ID, team2ID);

                    Response.Redirect("~/schedule.cshtml");
                }
                if (Request.Form["delete"] == "delete")
                {
                    accessData.DeleteMatch(int.Parse(MatchId));
                    Response.Redirect("~/schedule.cshtml");
                }
            }
            else
            {
                accessData.GetScheduleData(int.Parse(MatchId), out MatchTime, out Team1ID, out Team2ID);
                Team1 = accessData.GetTeamName(Team1ID);
                Team2 = accessData.GetTeamName(Team2ID);
            }

        }
        <form class="col s12" method="post" action="">
            <fieldset>
                <div class="row">
                    <div class="input-field col s12 m6 l4">
                        <input name="MatchTime" type="date" class="datepicker validate" value="@MatchTime">
                        <label for="MatchTime">Match Time</label>
                        <p class="red-text lighten-2">@Html.ValidationMessage("MatchTime")</p>
                    </div>
                    <div class="input-field col s12 m6 l4">
                        <select id="team1Select" name="Team1" onchange="checkValidity()">
                            <option value="0" disabled>Select a Team</option>
                            @{
                                List<string> team1s;
                                List<int> team1IDs;
                                accessData.GetTeams(out team1IDs, out team1s);
                                for (int i = 0; i < team1s.Count; i++)
                                {
                                    if (team1s[i] == Team1)
                                    {
                                        <option value="@team1IDs[i]" onload="addTeam(@team1IDs[i])" selected>@team1s[i]</option>
                                    }
                                    else
                                    {
                                        <option value="@team1IDs[i]" onload="addTeam(@team1IDs[i])" >@team1s[i]</option>
                                    }
                                }
                            }
                        </select>
                        <p class="red-text lighten-2">@Html.ValidationMessage("Team1")</p>
                    </div>
                    <div class="input-field col s12 m12 l4">
                        <select id="team2Select" name="Team2">
                            <option value="0" disabled>Select a Team</option>
                            @{
                                List<string> team2s;
                                List<int> team2IDs;
                                accessData.GetTeams(out team2IDs, out team2s);
                                for (int i = 0; i < team2s.Count; i++)
                                {
                                    if (team2s[i] == Team2)
                                    {
                                        <option value="@team2IDs[i]" id="2 @team2IDs[i]" selected>@team2s[i]</option>
                                    }
                                    else
                                    {
                                        <span id="2 @team2IDs[i]">
                                            <option value="@team2IDs[i]">@team2s[i]</option>
                                        </span>
                                    }
                                }
                            }
                        </select>
                        <p class="red-text lighten-2">@Html.ValidationMessage("Team2")</p>
                    </div>
                </div>
                <div class="row ">
                    <div class="col s6 m4 l4">
                        <a href="~/schedule.cshtml" class="btn waves-effect waves-light">Cancel</a>
                    </div>
                    <div class="col s6 m4 l4">
                        <button class="btn waves-effect waves-light" type="submit" name="update" value="update">Update</button>
                    </div>
                    <div class="col s6 m4 l4">
                        <button class="btn waves-effect waves-light" type="submit" name="delete" value="delete">Delete</button>
                    </div>
                </div>
            </fieldset>
        </form>
        @{
            List<int> teamsAtMatchTime;
            accessData.getTeamsFromDate(MatchTime, out teamsAtMatchTime);
            for (int i = 0; i < teamsAtMatchTime.Count; i++)
            {
                if (teamsAtMatchTime[i] != Team1ID && teamsAtMatchTime[i] != Team2ID)
                {
                    <span onload="addTeamAtMatch(teamsAtMatchTime[i])"></span>
                }
            }
        }
        <script type="text/javascript">
            $(document).ready(function () {
                $('select').material_select();
            });
            $('.datepicker').pickadate({
                selectMonths: true, // Creates a dropdown to control month
                selectYears: 15 // Creates a dropdown of 15 years to control year
            });

        </script>

        <script type="text/javascript">

            Array teamList = newArray[1];
            function addTeam(int id){
                Array temp= new Array[teamList.length + 1];
                for(int i = 0; i < teamList.length; i++){
                    temp[i] = teamList[i];
                }
                temp[teamList.length + 1] = id;

                teamList = temp;
            }

            var Selected1 = document.getElementById("team1Select").value;
            var Selected2 = document.getElementById("team2Select").value;

            Array teamAtMatchTimeList = newArray[1];
               
           
            
            function addTeamAtMatch(int id){
                Array temp= new Array[teamAtMatchTimeList.length + 1];
                for(int i = 0; i < teamAtMatchTimeList.length; i++){
                    temp[i] = teamAtMatchTimeList[i];
                }
                temp[teamAtMatchTimeList.length + 1] = id;

                teamAtMatchTimeList = temp;
            }

            function checkValidity(){
                //document.getElementById("2 " + Selected1).disabled = "false";
                //document.getElementById(Selected2).disabled = "false";
                
                Selected1 = document.getElementById("team1Select").value;
                Selected2 = document.getElementById("team2Select").value;
                //document.getElementById("2 " + Selected1).disabled = "true";
                //document.getElementById(Selected2).disabled = "true";

                for(int i = 0; i > teamAtMatchTimeList.length ; i ++){
                document.getElementById(teamAtMatchTimeList[i]).disabled = "true";
                document.getElementById("2 " + teamAtMatchTimeList[i]).disabled = "true";
                }
            }

        </script>
        
               
    </div>

</body>

</html>